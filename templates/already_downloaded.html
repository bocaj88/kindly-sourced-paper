{% extends "base.html" %}

{% block title %}Already Downloaded - KindleSource{% endblock %}

{% block content %}
<div class="container-fluid">
  <div class="row mb-4">
    <div class="col-12 d-flex justify-content-between align-items-center">
      <h1 class="h3 mb-0"><i class="bi bi-list-check"></i> Already Downloaded</h1>
      <div class="btn-group">
        <button class="btn btn-outline-secondary" onclick="refreshList()">
          <i class="bi bi-arrow-clockwise"></i> Refresh
        </button>
        <button class="btn btn-info" onclick="populateFromFiles()">
          <i class="bi bi-cloud-download"></i> Populate from Files
        </button>
      </div>
    </div>
  </div>

  <div class="row g-3">
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header">
          <strong>Titles</strong>
        </div>
        <div class="card-body">
          <div class="mb-3">
            <input id="filterInput" type="text" class="form-control" placeholder="Filter titles..." oninput="renderList()">
          </div>
          <div id="listContainer" style="max-height: 60vh; overflow: auto;" class="border rounded">
            <div class="p-3 text-muted">Loading...</div>
          </div>
          <small class="text-muted d-block mt-2">Click items to select multiple. Use the actions on the right to remove.</small>
        </div>
      </div>
    </div>
    <div class="col-12 col-lg-6">
      <div class="card">
        <div class="card-header">
          <strong>Actions</strong>
        </div>
        <div class="card-body">
          <div class="mb-3 d-flex gap-2">
            <input id="singleRemoveInput" type="text" class="form-control" placeholder="Exact title to remove">
            <button class="btn btn-outline-danger" onclick="removeSingle()"><i class="bi bi-trash"></i> Remove Title</button>
          </div>
          <div class="d-flex gap-2">
            <button id="removeSelectedBtn" class="btn btn-danger" disabled onclick="removeSelected()">
              <i class="bi bi-trash"></i> Remove Selected
            </button>
            <button class="btn btn-outline-secondary" onclick="clearSelection()">
              <i class="bi bi-x-circle"></i> Clear Selection
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
let titles = [];
let selected = new Set();

document.addEventListener('DOMContentLoaded', () => {
  loadList();
});

function showToast(message, type = 'info') {
  // Reuse base page alert pattern if available
  const container = document.createElement('div');
  container.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert" style="position:fixed; right:16px; bottom:16px; z-index:1060;">${message}<button type="button" class="btn-close" data-bs-dismiss="alert"></button></div>`;
  document.body.appendChild(container.firstChild);
  if (type === 'success' || type === 'info') {
    setTimeout(() => {
      const el = document.querySelector('.alert');
      if (el) new bootstrap.Alert(el).close();
    }, 2500);
  }
}

function loadList() {
  const container = document.getElementById('listContainer');
  container.innerHTML = '<div class="p-3 text-muted">Loading...</div>';
  fetch('/api/already-downloaded')
    .then(r => r.json())
    .then(data => {
      if (!data.success) {
        container.innerHTML = `<div class="p-3 text-danger">Failed to load: ${data.error || 'Unknown error'}</div>`;
        return;
      }
      titles = data.titles || [];
      selected.clear();
      renderList();
    })
    .catch(err => {
      container.innerHTML = `<div class="p-3 text-danger">Error: ${err.message}</div>`;
    });
}

function renderList() {
  const container = document.getElementById('listContainer');
  const filter = (document.getElementById('filterInput').value || '').toLowerCase();
  const filtered = titles.filter(t => t.toLowerCase().includes(filter));
  if (!filtered.length) {
    container.innerHTML = '<div class="p-3 text-muted">No titles</div>';
    document.getElementById('removeSelectedBtn').disabled = true;
    return;
  }
  const list = document.createElement('div');
  list.className = 'list-group list-group-flush';
  filtered.forEach(t => {
    const item = document.createElement('button');
    item.type = 'button';
    item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
    item.textContent = t;
    if (selected.has(t)) item.classList.add('active');
    item.onclick = () => toggleSelect(t, item);
    list.appendChild(item);
  });
  container.innerHTML = '';
  container.appendChild(list);
  document.getElementById('removeSelectedBtn').disabled = selected.size === 0;
}

function toggleSelect(title, el) {
  if (selected.has(title)) {
    selected.delete(title);
    el.classList.remove('active');
  } else {
    selected.add(title);
    el.classList.add('active');
  }
  document.getElementById('removeSelectedBtn').disabled = selected.size === 0;
}

function clearSelection() {
  selected.clear();
  renderList();
}

function removeSelected() {
  if (selected.size === 0) return;
  if (!confirm(`Remove ${selected.size} selected title(s)?`)) return;
  const titlesToRemove = Array.from(selected);
  fetch('/api/already-downloaded/remove', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ titles: titlesToRemove })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast(`Removed ${data.removed} title(s)`, 'success');
      const removeSet = new Set(titlesToRemove.map(t => t.toLowerCase()));
      titles = titles.filter(t => !removeSet.has(t.toLowerCase()));
      selected.clear();
      renderList();
    } else {
      showToast('Failed to remove: ' + (data.error || 'Unknown error'), 'danger');
    }
  })
  .catch(err => showToast('Error: ' + err.message, 'danger'));
}

function removeSingle() {
  const input = document.getElementById('singleRemoveInput');
  const title = (input.value || '').trim();
  if (!title) return;
  fetch('/api/already-downloaded/remove', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' },
    body: JSON.stringify({ title })
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast(`Removed ${data.removed} title(s)`, 'success');
      titles = titles.filter(t => t.toLowerCase() !== title.toLowerCase());
      input.value = '';
      renderList();
    } else {
      showToast('Failed to remove: ' + (data.error || 'Unknown error'), 'danger');
    }
  })
  .catch(err => showToast('Error: ' + err.message, 'danger'));
}

function populateFromFiles() {
  showToast('Scanning downloads folder...', 'info');
  fetch('/api/populate-downloaded', {
    method: 'POST',
    headers: { 'Content-Type': 'application/json' }
  })
  .then(r => r.json())
  .then(data => {
    if (data.success) {
      showToast(`Populated with ${data.count} books`, 'success');
      refreshList();
    } else {
      showToast('Failed to populate: ' + (data.error || 'Unknown error'), 'danger');
    }
  })
  .catch(err => showToast('Error: ' + err.message, 'danger'));
}

function refreshList() { loadList(); }
</script>

{% endblock %}


