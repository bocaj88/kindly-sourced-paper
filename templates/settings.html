{% extends "base.html" %}

{% block title %}Settings - KindleSource{% endblock %}

{% block extra_css %}
<style>
    .setting-group {
        background: #f8f9fa;
        border-radius: 8px;
        padding: 20px;
        margin-bottom: 20px;
        border-left: 4px solid #007bff;
    }
    
    .setting-label {
        font-weight: 600;
        color: #333;
        margin-bottom: 5px;
    }
    
    .setting-description {
        font-size: 0.9em;
        color: #666;
        margin-bottom: 10px;
    }
    
    .url-validation {
        margin-top: 5px;
        font-size: 0.85em;
    }
    
    .url-valid {
        color: #28a745;
    }
    
    .url-invalid {
        color: #dc3545;
    }
    
    .btn-group-sm {
        margin-top: 10px;
    }
    
    .export-import-section {
        background: #e9ecef;
        border-radius: 8px;
        padding: 15px;
        margin-top: 20px;
    }
</style>
{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2><i class="fas fa-cog"></i> Settings</h2>
                <div class="btn-group">
                    <button class="btn btn-outline-secondary" onclick="resetSettings()">
                        <i class="fas fa-undo"></i> Reset to Defaults
                    </button>
                    <button class="btn btn-success" onclick="saveSettings()">
                        <i class="fas fa-save"></i> Save Settings
                    </button>
                </div>
            </div>

            <!-- Alert for messages -->
            <div id="alertContainer"></div>

            <form id="settingsForm">
                <!-- Wishlist Configuration -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-list"></i> Amazon Wishlist URL
                    </div>
                    <div class="setting-description">
                        Enter your Amazon wishlist URL. You can find this by going to your wishlist and copying the URL from your browser.
                    </div>
                    <div class="input-group">
                        <input type="url" class="form-control" id="wishlist_url" name="wishlist_url" 
                               placeholder="https://www.amazon.com/hz/wishlist/ls/YOUR_WISHLIST_ID" 
                               onchange="validateWishlistUrl()">
                        <button class="btn btn-outline-secondary" type="button" onclick="testWishlist()">
                            <i class="fas fa-flask"></i> Test
                        </button>
                    </div>
                    <div id="urlValidation" class="url-validation"></div>
                </div>

                <!-- Download Preferences -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-download"></i> Download Preferences
                    </div>
                    <div class="setting-description">
                        Configure how books are downloaded and processed.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="preferred_formats" class="form-label">Preferred Book Formats (in order)</label>
                            <div id="formatsList">
                                <!-- Will be populated by JavaScript -->
                            </div>
                            <button type="button" class="btn btn-sm btn-outline-primary mt-2" onclick="addFormat()">
                                <i class="fas fa-plus"></i> Add Format
                            </button>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="download_timeout" class="form-label">Download Timeout (seconds)</label>
                            <input type="number" class="form-control" id="download_timeout" name="download_timeout" 
                                   min="10" max="300" value="30">
                            
                            <label for="max_concurrent_downloads" class="form-label mt-3">Max Concurrent Downloads</label>
                            <input type="number" class="form-control" id="max_concurrent_downloads" name="max_concurrent_downloads" 
                                   min="1" max="10" value="3">
                        </div>
                    </div>
                </div>

                <!-- Kindle Settings -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-tablet-alt"></i> Kindle Settings
                    </div>
                    <div class="setting-description">
                        Configure how books are sent to your Kindle device.
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="auto_send_to_kindle" name="auto_send_to_kindle">
                        <label class="form-check-label" for="auto_send_to_kindle">
                            Automatically send downloaded books to Kindle
                        </label>
                    </div>
                </div>

                <!-- Amazon Authentication Settings -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-key"></i> Amazon Authentication
                    </div>
                    <div class="setting-description">
                        Configure your Amazon credentials for automatic sign-in when setting up Kindle authentication.
                        These credentials are stored locally and used to automate the login process.
                    </div>
                    
                    <div class="row">
                        <div class="col-md-6">
                            <label for="amazon_username" class="form-label">Amazon Email/Username</label>
                            <input type="email" class="form-control" id="amazon_username" name="amazon_username" 
                                   placeholder="your.email@example.com">
                            <small class="form-text text-muted">Your Amazon account email address</small>
                        </div>
                        
                        <div class="col-md-6">
                            <label for="amazon_password" class="form-label">Amazon Password</label>
                            <div class="input-group">
                                <input type="password" class="form-control" id="amazon_password" name="amazon_password" 
                                       placeholder="Enter your Amazon password">
                                <button class="btn btn-outline-secondary" type="button" onclick="togglePasswordVisibility('amazon_password')">
                                    <i class="fas fa-eye" id="amazon_password_toggle_icon"></i>
                                </button>
                            </div>
                            <small class="form-text text-muted">Your Amazon account password</small>
                        </div>
                    </div>
                    
                    <div class="alert alert-info mt-3" role="alert">
                        <i class="fas fa-info-circle"></i>
                        <strong>Security Note:</strong> Your credentials are stored locally in your settings file and are only used to automate the Amazon login process. 
                        Leave these fields empty if you prefer to sign in manually each time.
                    </div>
                    
                    <div class="alert alert-warning mt-2" role="alert">
                        <i class="fas fa-exclamation-triangle"></i>
                        <strong>Two-Factor Authentication:</strong> If you have 2FA enabled on your Amazon account, 
                        you'll still need to complete the 2FA step manually even with credentials configured.
                    </div>
                </div>

                <!-- Notification Settings -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-bell"></i> Notifications
                    </div>
                    <div class="setting-description">
                        Configure SMS notifications for download status updates.
                    </div>
                    
                    <label for="notification_phone" class="form-label">Phone Number (optional)</label>
                    <input type="tel" class="form-control" id="notification_phone" name="notification_phone" 
                           placeholder="+1234567890">
                    <small class="form-text text-muted">Leave empty to disable SMS notifications</small>
                </div>

                <!-- Cache Settings -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-database"></i> Cache Settings
                    </div>
                    <div class="setting-description">
                        Configure caching to speed up repeated wishlist crawls.
                    </div>
                    
                    <label for="cache_expiry_hours" class="form-label">Cache Expiry (hours)</label>
                    <input type="number" class="form-control" id="cache_expiry_hours" name="cache_expiry_hours" 
                           min="1" max="168" value="24">
                    <small class="form-text text-muted">How long to keep cached book data (1-168 hours)</small>
                </div>

                <!-- User Agent Settings -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-globe"></i> Browser Compatibility
                    </div>
                    <div class="setting-description">
                        Your browser's user agent is automatically cached to improve Amazon compatibility and reduce blocking.
                    </div>
                    
                    <div id="userAgentStatus" class="alert alert-info" role="alert">
                        <i class="fas fa-spinner fa-spin"></i> Checking user agent status...
                    </div>
                    
                    <button type="button" class="btn btn-sm btn-outline-primary" onclick="refreshUserAgent()">
                        <i class="fas fa-sync"></i> Refresh User Agent
                    </button>
                </div>

                <!-- Advanced Settings -->
                <div class="setting-group">
                    <div class="setting-label">
                        <i class="fas fa-tools"></i> Advanced Settings
                    </div>
                    <div class="setting-description">
                        Advanced configuration options for debugging and development.
                    </div>
                    
                    <div class="form-check">
                        <input class="form-check-input" type="checkbox" id="debug_mode" name="debug_mode">
                        <label class="form-check-label" for="debug_mode">
                            Enable debug mode (saves debug files)
                        </label>
                    </div>
                </div>
            </form>

            <!-- Already Downloaded Management -->
            <div class="setting-group">
                <div class="setting-label">
                    <i class="fas fa-list-check"></i> Already Downloaded Management
                </div>
                <div class="setting-description">
                    Manage the list of books that have already been downloaded to prevent duplicates.
                </div>
                
                <button type="button" class="btn btn-info" onclick="populateAlreadyDownloaded()">
                    <i class="fas fa-sync"></i> Populate from Existing Files
                </button>
                <div class="form-text mt-2">
                    This will scan your downloads folder and add any existing books to the "already downloaded" list to prevent re-downloading them.
                </div>

                    <hr>
                    <div class="setting-label">
                        <i class="fas fa-book"></i> Already Downloaded Titles
                    </div>
                    <div class="mb-2">
                        <input id="alreadyDownloadedFilter" type="text" class="form-control" placeholder="Filter titles..." oninput="renderAlreadyDownloaded()">
                    </div>
                    <div class="mb-2 d-flex gap-2">
                        <input id="removeTitleInput" type="text" class="form-control" placeholder="Exact title to remove">
                        <button type="button" class="btn btn-outline-danger" onclick="removeSingleTitle()">
                            <i class="fas fa-trash"></i> Remove Title
                        </button>
                        <button type="button" class="btn btn-outline-danger" onclick="removeSelectedTitles()" id="removeSelectedBtn" disabled>
                            <i class="fas fa-trash"></i> Remove Selected
                        </button>
                    </div>
                    <div id="alreadyDownloadedContainer" class="mt-2" style="max-height: 280px; overflow:auto; border: 1px solid #e0e0e0; border-radius: 6px;">
                        <div class="p-3 text-muted">Loading...</div>
                    </div>
                    <div class="form-text mt-2">Click to select multiple. Use the trash buttons above to remove.</div>
            </div>

            <!-- Export/Import Section -->
            <div class="export-import-section">
                <h5><i class="fas fa-exchange-alt"></i> Export/Import Settings</h5>
                <div class="row">
                    <div class="col-md-6">
                        <button class="btn btn-outline-primary" onclick="exportSettings()">
                            <i class="fas fa-download"></i> Export Settings
                        </button>
                        <small class="form-text text-muted">Download your settings as a JSON file</small>
                    </div>
                    <div class="col-md-6">
                        <input type="file" class="form-control" id="importFile" accept=".json" onchange="importSettings()">
                        <small class="form-text text-muted">Import settings from a JSON file</small>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
let currentSettings = {};

// Load settings on page load
document.addEventListener('DOMContentLoaded', function() {
    loadSettings();
    checkUserAgentStatus();
    loadAlreadyDownloaded();
});

function loadSettings() {
    fetch('/api/settings')
        .then(response => response.json())
        .then(data => {
            currentSettings = data;
            populateForm(data);
            validateWishlistUrl();
        })
        .catch(error => {
            showAlert('Failed to load settings', 'danger');
        });
}

function populateForm(settings) {
    document.getElementById('wishlist_url').value = settings.wishlist_url || '';
    document.getElementById('download_timeout').value = settings.download_timeout || 30;
    document.getElementById('max_concurrent_downloads').value = settings.max_concurrent_downloads || 3;
    document.getElementById('auto_send_to_kindle').checked = settings.auto_send_to_kindle || false;
    document.getElementById('notification_phone').value = settings.notification_phone || '';
    document.getElementById('cache_expiry_hours').value = settings.cache_expiry_hours || 24;
    document.getElementById('debug_mode').checked = settings.debug_mode || false;
    document.getElementById('amazon_username').value = settings.amazon_username || '';
    document.getElementById('amazon_password').value = settings.amazon_password || '';
    
    // Populate preferred formats
    populateFormats(settings.preferred_formats || ['epub', 'pdf', 'mobi']);
}

function populateFormats(formats) {
    const container = document.getElementById('formatsList');
    container.innerHTML = '';
    
    formats.forEach((format, index) => {
        const formatDiv = document.createElement('div');
        formatDiv.className = 'input-group mb-2';
        formatDiv.innerHTML = `
            <span class="input-group-text">${index + 1}</span>
            <input type="text" class="form-control format-input" value="${format}" onchange="updateFormats()">
            <button class="btn btn-outline-danger" type="button" onclick="removeFormat(this)">
                <i class="fas fa-trash"></i>
            </button>
        `;
        container.appendChild(formatDiv);
    });
}

function addFormat() {
    const container = document.getElementById('formatsList');
    const count = container.children.length;
    const formatDiv = document.createElement('div');
    formatDiv.className = 'input-group mb-2';
    formatDiv.innerHTML = `
        <span class="input-group-text">${count + 1}</span>
        <input type="text" class="form-control format-input" placeholder="pdf" onchange="updateFormats()">
        <button class="btn btn-outline-danger" type="button" onclick="removeFormat(this)">
            <i class="fas fa-trash"></i>
        </button>
    `;
    container.appendChild(formatDiv);
}

function removeFormat(button) {
    button.closest('.input-group').remove();
    updateFormats();
    // Renumber the remaining items
    const formatItems = document.querySelectorAll('#formatsList .input-group');
    formatItems.forEach((item, index) => {
        item.querySelector('.input-group-text').textContent = index + 1;
    });
}

function updateFormats() {
    // This will be called when saving
}

function validateWishlistUrl() {
    const url = document.getElementById('wishlist_url').value;
    const validation = document.getElementById('urlValidation');
    
    if (!url) {
        validation.innerHTML = '';
        validation.classList.remove('url-valid', 'url-invalid');
        return;
    }
    
    const validPatterns = [
        'amazon.com/hz/wishlist/ls/',
        'amazon.co.uk/hz/wishlist/ls/',
        'amazon.ca/hz/wishlist/ls/',
        'amazon.de/hz/wishlist/ls/',
        'amazon.fr/hz/wishlist/ls/',
        'amazon.it/hz/wishlist/ls/',
        'amazon.es/hz/wishlist/ls/',
        'amazon.com.au/hz/wishlist/ls/',
        'amazon.co.jp/hz/wishlist/ls/'
    ];
    
    const isValid = validPatterns.some(pattern => url.toLowerCase().includes(pattern));
    
    if (isValid) {
        validation.innerHTML = '<i class="fas fa-check"></i> Valid Amazon wishlist URL';
        validation.classList.remove('url-invalid');
        validation.classList.add('url-valid');
    } else {
        validation.innerHTML = '<i class="fas fa-times"></i> Invalid wishlist URL format';
        validation.classList.remove('url-valid');
        validation.classList.add('url-invalid');
    }
}

function testWishlist() {
    const url = document.getElementById('wishlist_url').value;
    if (!url) {
        showAlert('Please enter a wishlist URL first', 'warning');
        return;
    }
    
    showAlert('Testing wishlist URL... Can take up to 30 seconds... be patient!', 'info');
    
    fetch('/api/test-wishlist', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({url: url})
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Success! Found ${data.book_count} books in wishlist`, 'success');
        } else {
            showAlert(`Test failed: ${data.error}`, 'danger');
        }
    })
    .catch(error => {
        showAlert('Failed to test wishlist URL', 'danger');
    });
}

function saveSettings() {
    const formatInputs = document.querySelectorAll('.format-input');
    const preferredFormats = Array.from(formatInputs).map(input => input.value).filter(f => f);
    
    const formData = {
        wishlist_url: document.getElementById('wishlist_url').value,
        preferred_formats: preferredFormats,
        auto_send_to_kindle: document.getElementById('auto_send_to_kindle').checked,
        notification_phone: document.getElementById('notification_phone').value || null,
        download_timeout: parseInt(document.getElementById('download_timeout').value) || 30,
        max_concurrent_downloads: parseInt(document.getElementById('max_concurrent_downloads').value) || 3,
        cache_expiry_hours: parseInt(document.getElementById('cache_expiry_hours').value) || 24,
        debug_mode: document.getElementById('debug_mode').checked,
        amazon_username: document.getElementById('amazon_username').value || null,
        amazon_password: document.getElementById('amazon_password').value || null
    };
    
    fetch('/api/settings', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify(formData)
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('Settings saved successfully!', 'success');
            currentSettings = formData;
        } else {
            showAlert('Failed to save settings', 'danger');
        }
    })
    .catch(error => {
        showAlert('Failed to save settings', 'danger');
    });
}

function resetSettings() {
    if (confirm('Are you sure you want to reset all settings to defaults?')) {
        fetch('/api/settings/reset', {
            method: 'POST'
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                showAlert('Settings reset to defaults', 'success');
                loadSettings();
            } else {
                showAlert('Failed to reset settings', 'danger');
            }
        })
        .catch(error => {
            showAlert('Failed to reset settings', 'danger');
        });
    }
}

function exportSettings() {
    fetch('/api/settings/export')
        .then(response => response.text())
        .then(data => {
            const blob = new Blob([data], {type: 'application/json'});
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = 'kindlesource_settings.json';
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            showAlert('Settings exported successfully', 'success');
        })
        .catch(error => {
            showAlert('Failed to export settings', 'danger');
        });
}

function importSettings() {
    const file = document.getElementById('importFile').files[0];
    if (!file) return;
    
    const reader = new FileReader();
    reader.onload = function(e) {
        try {
            const settings = JSON.parse(e.target.result);
            fetch('/api/settings/import', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({settings: JSON.stringify(settings)})
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    showAlert('Settings imported successfully!', 'success');
                    loadSettings();
                } else {
                    showAlert('Failed to import settings: ' + data.error, 'danger');
                }
            })
            .catch(error => {
                showAlert('Failed to import settings', 'danger');
            });
        } catch (error) {
            showAlert('Invalid JSON file', 'danger');
        }
    };
    reader.readAsText(file);
}

function showAlert(message, type) {
    const alertHtml = `
        <div class="alert alert-${type} alert-dismissible fade show" role="alert">
            ${message}
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    `;
    document.getElementById('alertContainer').innerHTML = alertHtml;
    
    // Auto-hide success and info alerts after 3 seconds
    if (type === 'success' || type === 'info') {
        setTimeout(() => {
            const alert = document.querySelector('.alert');
            if (alert) {
                const bsAlert = new bootstrap.Alert(alert);
                bsAlert.close();
            }
        }, 3000);
    }
}

function checkUserAgentStatus() {
    fetch('/api/get-user-agent-status')
        .then(response => response.json())
        .then(data => {
            const statusDiv = document.getElementById('userAgentStatus');
            let statusHtml = '';
            let alertClass = 'alert-info';
            
            if (data.has_cached_user_agent) {
                if (data.is_fresh) {
                    statusHtml = `<i class="fas fa-check-circle text-success"></i> <strong>Active:</strong> Using your browser's user agent for better Amazon compatibility.<br>
                                 <small class="text-muted">User Agent: ${data.user_agent_preview}<br>
                                 Last updated: ${new Date(data.last_updated * 1000).toLocaleString()}</small>`;
                    alertClass = 'alert-success';
                } else {
                    statusHtml = `<i class="fas fa-exclamation-triangle text-warning"></i> <strong>Stale:</strong> User agent cache is old and will be refreshed automatically.<br>
                                 <small class="text-muted">User Agent: ${data.user_agent_preview}</small>`;
                    alertClass = 'alert-warning';
                }
            } else {
                statusHtml = `<i class="fas fa-info-circle text-info"></i> <strong>Not Cached:</strong> Your browser's user agent will be captured automatically to improve Amazon compatibility.`;
                alertClass = 'alert-info';
            }
            
            statusDiv.className = `alert ${alertClass}`;
            statusDiv.innerHTML = statusHtml;
        })
        .catch(error => {
            const statusDiv = document.getElementById('userAgentStatus');
            statusDiv.className = 'alert alert-danger';
            statusDiv.innerHTML = '<i class="fas fa-times-circle"></i> <strong>Error:</strong> Failed to check user agent status.';
        });
}

function refreshUserAgent() {
    const userAgent = navigator.userAgent;
    
    fetch('/api/update-user-agent', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        },
        body: JSON.stringify({
            user_agent: userAgent
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert('User agent refreshed successfully! This will improve Amazon compatibility.', 'success');
            checkUserAgentStatus(); // Refresh the status display
        } else {
            showAlert('Failed to refresh user agent: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error refreshing user agent: ' + error.message, 'danger');
    });
}

function populateAlreadyDownloaded() {
    showAlert('Scanning downloads folder...', 'info');
    
    fetch('/api/populate-downloaded', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json'
        }
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            showAlert(`Successfully populated already downloaded list with ${data.count} books!`, 'success');
        } else {
            showAlert('Failed to populate already downloaded list: ' + data.error, 'danger');
        }
    })
    .catch(error => {
        showAlert('Error populating already downloaded list: ' + error.message, 'danger');
    });
}

// Already downloaded management
let alreadyDownloadedTitles = [];
let selectedTitleSet = new Set();

function loadAlreadyDownloaded() {
    const container = document.getElementById('alreadyDownloadedContainer');
    container.innerHTML = '<div class="p-3 text-muted">Loading...</div>';
    fetch('/api/already-downloaded')
        .then(r => r.json())
        .then(data => {
            if (!data.success) {
                container.innerHTML = `<div class="p-3 text-danger">Failed to load: ${data.error || 'Unknown error'}</div>`;
                return;
            }
            alreadyDownloadedTitles = data.titles || [];
            selectedTitleSet.clear();
            renderAlreadyDownloaded();
        })
        .catch(err => {
            container.innerHTML = `<div class="p-3 text-danger">Error: ${err.message}</div>`;
        });
}

function renderAlreadyDownloaded() {
    const filter = (document.getElementById('alreadyDownloadedFilter').value || '').toLowerCase();
    const container = document.getElementById('alreadyDownloadedContainer');
    const filtered = alreadyDownloadedTitles.filter(t => t.toLowerCase().includes(filter));
    if (filtered.length === 0) {
        container.innerHTML = '<div class="p-3 text-muted">No titles</div>';
        document.getElementById('removeSelectedBtn').disabled = true;
        return;
    }
    const list = document.createElement('div');
    list.className = 'list-group list-group-flush';
    filtered.forEach(title => {
        const item = document.createElement('button');
        item.type = 'button';
        item.className = 'list-group-item list-group-item-action d-flex justify-content-between align-items-center';
        item.textContent = title;
        item.onclick = () => toggleSelectTitle(title, item);
        if (selectedTitleSet.has(title)) {
            item.classList.add('active');
        }
        list.appendChild(item);
    });
    container.innerHTML = '';
    container.appendChild(list);
    document.getElementById('removeSelectedBtn').disabled = selectedTitleSet.size === 0;
}

function toggleSelectTitle(title, element) {
    if (selectedTitleSet.has(title)) {
        selectedTitleSet.delete(title);
        element.classList.remove('active');
    } else {
        selectedTitleSet.add(title);
        element.classList.add('active');
    }
    document.getElementById('removeSelectedBtn').disabled = selectedTitleSet.size === 0;
}

function removeSelectedTitles() {
    if (selectedTitleSet.size === 0) return;
    if (!confirm(`Remove ${selectedTitleSet.size} selected title(s)?`)) return;
    const titles = Array.from(selectedTitleSet);
    fetch('/api/already-downloaded/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ titles })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showAlert(`Removed ${data.removed} title(s)`, 'success');
            // Update local list
            const removeSet = new Set(titles.map(t => t.toLowerCase()));
            alreadyDownloadedTitles = alreadyDownloadedTitles.filter(t => !removeSet.has(t.toLowerCase()));
            selectedTitleSet.clear();
            renderAlreadyDownloaded();
        } else {
            showAlert('Failed to remove: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(err => showAlert('Error: ' + err.message, 'danger'));
}

function removeSingleTitle() {
    const input = document.getElementById('removeTitleInput');
    const title = (input.value || '').trim();
    if (!title) return;
    fetch('/api/already-downloaded/remove', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ title })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            showAlert(`Removed ${data.removed} title(s)`, 'success');
            alreadyDownloadedTitles = alreadyDownloadedTitles.filter(t => t.toLowerCase() !== title.toLowerCase());
            input.value = '';
            renderAlreadyDownloaded();
        } else {
            showAlert('Failed to remove: ' + (data.error || 'Unknown error'), 'danger');
        }
    })
    .catch(err => showAlert('Error: ' + err.message, 'danger'));
}

function togglePasswordVisibility(fieldId) {
    const passwordField = document.getElementById(fieldId);
    const toggleIcon = document.getElementById(fieldId + '_toggle_icon');
    
    if (passwordField.type === 'password') {
        passwordField.type = 'text';
        toggleIcon.classList.remove('fa-eye');
        toggleIcon.classList.add('fa-eye-slash');
    } else {
        passwordField.type = 'password';
        toggleIcon.classList.remove('fa-eye-slash');
        toggleIcon.classList.add('fa-eye');
    }
}
</script>
{% endblock %} 